# Issue：美式三叉树早期行权边界记录为「首节点」而非「临界 S*」

- **日期**：2025-01-30
- **分类**：计算模块

---

## 现象

- 三叉树美式看跌 `trinomialAmericanPut` 中，早期行权边界 S* 应表示「该时刻仍应提前行权的**最高**即期」（低于此应行权）。
- 原实现：`if (intrinsic > hold && boundaryS === null) boundaryS = spot`，只记录**第一个**（即 spot 最小的节点）发生行权的即期。三叉树中 i 从 0 到 width-1 对应 spot 从低到高，故记录的是最低行权 spot，而非临界 S*。

---

## 原因

- 边界定义应为「最大 S 仍行权」，即同一时间步中应取**最后一个**（最高 spot）满足 intrinsic > hold 的节点。原逻辑只记第一个，方向反了。

---

## 解决方案

1. 在 `models/american/binomialTree.ts` 的 `trinomialAmericanPut` 中，将
   - `if (intrinsic > hold && boundaryS === null) boundaryS = spot`
   - 改为 `if (intrinsic > hold) boundaryS = spot`
2. 这样在 i 从 0 到 width-1 的循环中会不断覆盖，最终 boundaryS 为该时间步**最高**行权即期，即临界 S*。

---

## 相关链接 / 参考

- 需求书-美式期权模块：早期行权边界为「临界即期 S*，低于此应提前行权」；models/types.ts `EarlyExerciseBoundaryPoint`。

---

## 备注

- 测试团队在美式期权模块测试中发现；已按上述方案修改。二叉树 CRR 中 i 从高 spot 到低 spot 遍历，原逻辑已正确记录最高行权 spot，无需修改。
