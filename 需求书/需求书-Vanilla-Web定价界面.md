# 需求书：Vanilla 期权 Web 定价界面

**文档版本**：v1.0  
**对应项目**：外汇期权计算器 — 阶段一 Web UI  
**参考案例**：验证 Fenics EURUSD 案例（`验证Fenics_EURUSD_20251229.py`）  
**关联文档**：[开发流程设计.md](../开发流程设计.md)、[功能规格-期权类型与定价.md](../功能规格-期权类型与定价.md)

---

## 一、需求概述

实现 **Vanilla（欧式香草）期权** 的 Web 定价界面：用户通过表单输入合约与市场参数，系统调用 Garman-Kohlhagen 定价与 Greeks，在页面上展示**期权价格、Premium** 及**全部指定 Greeks**。输入/输出口径与参考 Python 案例（Fenics/QuantLib）对齐，便于后续用同一案例做回归验证。

---

## 二、输入规格

以下为**必填输入项**，需在 Web 界面提供输入控件（类型、单位、校验规则见下表）。

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 1 | 货币对 | `currencyPair` | 字符串或下拉 | 如 `EURUSD`、`USDJPY`、**`USDCNY`** | 可选：下拉枚举或自由输入；支持 **USDCNY**（本币 CNY、外币 USD，即期/执行价为 USDCNY 汇率）；用于展示与报价惯例（本币/外币） |
| 2 | 当前日期 | `today` / `valuationDate` | 日期 | `YYYY-MM-DD` | 定价基准日，必须 ≤ 起息日、≤ 到期日 |
| 3 | 起息日 | `premiumDate` / `valueDate` | 日期 | `YYYY-MM-DD` | 期权费起息日（Premium 支付日）；必须 ≥ 当前日期 |
| 4 | 到期日 | `maturityDate` | 日期 | `YYYY-MM-DD` | 期权到期日；必须 ≥ 起息日 |
| 5 | 交割日 | `settlementDate` | 日期 | `YYYY-MM-DD` | 交割日；建议 ≥ 到期日（T+2 等惯例可由前端默认或说明） |
| 6 | 即期价格 | `spot` / `S` | 数值 | 与货币对报价一致（如 EURUSD 即期） | > 0；小数位数按货币对惯例（如 4 位） |
| 7 | 执行价格 | `strike` / `K` | 数值 | 与即期同报价方式 | > 0 |
| 8 | 本币利率 | `r_d` / `rateDomestic` | 数值 | 小数（如 0.04 表示 4%） | 连续复利年化；建议输入小数，界面可注明「如 4% 输入 0.04」 |
| 9 | 外币利率 | `r_f` / `rateForeign` | 数值 | 小数（如 0.02 表示 2%） | 连续复利年化；同上 |
| 10 | 名义本金 | `notional` | 数值 | 单位：外币（如 EUR 名义本金） | > 0；整数或合理小数 |
| 11 | 买卖方向 | `longOrShort` | 枚举 | `long` / `short` | 多头或空头 |
| 12 | 期权类型 | `optionType` | 枚举 | `call` / `put` | 看涨 / 看跌 |
| 13 | 隐含波动率 | `sigma` / `IV` | 数值 | 小数（如 0.06 表示 6%） | > 0；年化 |

**日期与期限约定（与参考案例一致）**：

- **T1** =（到期日 − 当前日期）/ 365（**年化**），用于 d1/d2 及期权存续期。
- **T2** =（交割日 − 起息日）/ 365（**年化**），用于**期权费折现**（从交割日折到起息日）。
- 开发时需在计算层支持 **T1、T2 双期限**：d1/d2 用 T1，折现因子用 T2（参考 `验证Fenics_EURUSD_20251229.py` 中 `exp_rf_T2`、`exp_rd_T2`）。

**可选扩展输入**（首期可不做，预留接口即可）：

- 掉期点 `swapPips`（参考案例中有，用于某些 Delta 口径如 PA delta；首期可只做标准 Delta）。

---

## 三、输出规格

以下为**必须输出的结果项**，需在 Web 界面明确展示，并注明单位与含义。

| 序号 | 输出项（中文） | 英文/内部名称 | 含义 | 单位/展示方式 |
|------|----------------|---------------|------|----------------|
| 1 | 期权价格 | `optionPrice` / `price` | 每单位名义本币的期权价值（Garman-Kohlhagen 解析价） | 小数，如 0.01234；可注明「每 1 单位外币」 |
| 2 | Premium | `premium` | 期权费金额 = 期权价格 × 名义本金 | **本币金额**（如 USD）及可选 **外币等值**（如 EUR = premium/spot）；可选展示为 **% of spot**（如 `(price/spot)*100`%） |
| 3 | Delta | `delta` | ∂V/∂S，对即期汇率的敏感度 | 每 1 单位名义：小数；**头寸 Delta** = delta × 名义本金 × 买卖方向，单位：**外币**（如 EUR）；参考案例中 long put 为负 Delta 头寸 |
| 4 | Gamma | `gamma` | ∂²V/∂S² | 每 1 单位名义；可选再给出「头寸 Gamma」说明 |
| 5 | Vega | `vega` | ∂V/∂σ，按 **1% 波动率** 变化（即 0.01） | 每 1 单位名义：本币金额变化；头寸 Vega = vega × 名义本金 × 买卖方向 |
| 6 | VolGamma | `volGamma` / `vanna` | ∂²V/(∂S∂σ) 或 ∂²V/∂σ²（按 1% vol） | 每 1 单位名义；若实现二阶对波动率敏感度，需在计算模块中增加 |
| 7 | Time Decay | `timeDecay` | 时间衰减：期权价值随「到期日前进 1 天」的变化 | 与 Theta 同口径：**按 1 天**；单位：本币金额/天（头寸 = × 名义本金 × 买卖方向）；参考案例用 Bump T1 定义 |
| 8 | Phi | `phi` | 对外币利率的敏感度 | 即 **Rho_f**：∂V/∂r_f；按 1bp 或 1 单位利率变化，单位需统一注明 |
| 9 | Rho | `rho` | 对本币利率的敏感度 | 即 **Rho_d**：∂V/∂r_d；按 1bp 或 1 单位利率变化 |
| 10 | Theta | `theta` | ∂V/∂t，按 **1 天**（1/365 年） | 与 Time Decay 一致或注明区别（如 Theta 为解析式，Time Decay 为 Bump T1 数值）；单位：本币/天 |

**输出与参考案例的对应关系**：

- **Premium**：对应脚本中 `Option_quote_premium`（本币）、`Option_analytic/spot*100`（%）。
- **Delta**：对应 `Delta_position`（头寸，外币）、解析式与 Bump 一致。
- **Theta / Time Decay**：参考案例中有「解析 Theta（d1/d2）」「Bump T1」「Bump T2」「Bump T1+T2」；界面至少提供一种（建议 **Bump T1** 作为 Time Decay，与 Fenics 一致），其余可后续扩展。
- **Phi** = Rho_f，**Rho** = Rho_d。

---

## 四、计算层与接口要求

1. **定价模型**：Garman-Kohlhagen（与 [功能规格-期权类型与定价.md](../功能规格-期权类型与定价.md) 及现有 `models/vanilla/garmanKohlhagen.ts` 一致）。
2. **双期限 T1、T2**：
   - 当前若计算模块仅支持单一 `T`，需**扩展**为：`T1`（到期 − 今日）、`T2`（交割 − 起息）；d1/d2 用 T1，折现用 T2。
   - 接口示例：`priceAndGreeks({ S, K, r_d, r_f, sigma, T1, T2 }, optionType, longOrShort)`，返回含 price、delta、gamma、vega、theta、rho_d、rho_f 等；若支持 **volGamma**，一并返回。
3. **买卖方向**：计算层输出「多头」Greeks；前端根据 `longOrShort` 对 Delta/Vega/Theta 等取反（与参考脚本中 `long_or_short == "long"` 逻辑一致）。
4. **名义本金**：计算层可只算「单位名义」；前端用「期权价格 × 名义本金」得到 Premium，用「Greeks × 名义本金」得到头寸 Greeks，再按买卖方向调整。

---

## 五、前端交互与 UI 要求

1. **布局**：输入区（表单）+ 结果区（输出表格或卡片），结构清晰。
2. **输入方式**：日期用日期选择器；利率、波动率、即期、执行价、名义本金用数字输入框；货币对、买卖方向、期权类型用下拉或单选。
3. **计算触发**：支持「点击计算按钮」触发；可选支持修改输入后自动重新计算（防抖建议 300–500ms）。
4. **校验**：提交前校验日期顺序（当前 ≤ 起息 ≤ 到期、交割 ≥ 到期等）、数值 > 0、利率/波动率合理范围；错误在输入框旁或顶部提示。
5. **输出展示**：所有 10 项输出均需展示；Premium 建议同时给出本币金额与可选「% of spot」；Greeks 注明单位（每单位名义 / 头寸、本币/外币、按 1 天/1% vol 等）。
6. **加载与异常**：计算中可显示 loading；计算失败或参数非法时给出明确提示。

---

## 六、验收标准

| 项 | 验收内容 |
|----|----------|
| 1 | 输入项完整：货币对（含 **USDCNY**）、当前日期、起息日、到期日、交割日、即期、执行价、本币/外币利率、名义本金、买卖方向、期权类型、隐含波动率 |
| 2 | 输出项完整：期权价格、Premium（本币及可选 %）、Delta、Vega、Gamma、VolGamma、Time Decay、Phi、Rho、Theta |
| 3 | 与参考案例数值一致：使用 `验证Fenics_EURUSD_20251229.py` 同一组参数（含 T1/T2、双利率），Web 端期权价格、Premium、Delta、Theta 与脚本输出在约定精度内一致（如小数点后 2 位金额、4 位比率） |
| 4 | 买卖方向正确：Short 时 Delta/Vega/Theta 等符号与参考案例一致 |
| 5 | 日期与 T1/T2：T1=(到期−今日)/365，T2=(交割−起息)/365，折现使用 T2 |

---

## 七、开发任务拆解（供开发团队执行）

| 步骤 | 任务 | 产出 |
|------|------|------|
| 1 | **计算层扩展** | 支持 T1、T2 双期限；折现用 T2，d1/d2 用 T1；可选实现 volGamma（∂²V/∂σ² 或 vanna） |
| 2 | **计算层接口** | 统一入口：输入 S,K,r_d,r_f,sigma,T1,T2,optionType,longOrShort；输出 price + 全部 Greeks（含 phi=rho_f, rho=rho_d）；头寸与名义本金由前端乘 |
| 3 | **前端页面** | 单页或路由：Vanilla 定价表单 + 结果区；表单含上述 13 项输入 |
| 4 | **前端联调** | 调用计算模块，展示 10 项输出；Premium 展示本币 + 可选 %；Greeks 注明单位 |
| 5 | **校验与回归** | 用 Fenics 案例参数做端到端比对；记录差异到 Issues（若有） |

---

## 八、参考案例参数（用于回归）

以下可直接用于与 `验证Fenics_EURUSD_20251229.py` 对比（Put、Long）：

- 当前日期：2025-12-29  
- 起息日：2025-12-31  
- 到期日：2026-01-28  
- 交割日：2026-01-30  
- 即期：1.1575  
- 执行价：1.15  
- 本币利率：0.040897679  
- 外币利率：0.018984441  
- 隐含波动率：0.062372965  
- 名义本金：1,000,000 EUR  
- 买卖方向：long  
- 期权类型：put  

预期可对比输出：期权价格（每单位）、Premium（USD）、Delta（EUR）、Theta/Time Decay（USD/天 或 EUR/天）等，与脚本一致到约定小数位。

---

## 九、货币对扩展：USDCNY

- **范围**：界面货币对下拉需支持 **USDCNY**（人民币对美元）。
- **报价惯例**：本币 CNY、外币 USD；即期 S、执行价 K 为「1 美元兑多少人民币」；名义本金单位为外币（USD）；Premium 等金额为本币（CNY）。
- **验收**：在界面选择 USDCNY，输入一组合法参数（即期、执行价、利率、波动率等），点击「计算」能正常得到期权价格、Premium、Greeks；无额外计算逻辑变更，仅增加枚举选项。

---

**文档结束**。开发团队可按「七、开发任务拆解」执行；若计算层或前端需更细的接口定义（如 TypeScript 类型、API 形状），可在此基础上追加附录或单独接口文档。
