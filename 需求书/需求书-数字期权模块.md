# 需求书：数字期权模块

**文档版本**：v1.0  
**对应项目**：外汇期权计算器 — 阶段一 Web UI（在现有计算器中新增模块）  
**关联文档**：[开发流程设计.md](../开发流程设计.md)、[需求书-Vanilla-Web定价界面.md](./需求书-Vanilla-Web定价界面.md)、[功能规格-期权类型与定价.md](../功能规格-期权类型与定价.md)  
**计算层依据**：现有 `models/digital/`（Cash-or-Nothing / Asset-or-Nothing 解析定价与 Greeks），类型见 `models/types.ts` 中 `DigitalParams`、`DigitalResult`。

---

## 一、需求概述

在现有 **外汇期权计算器** Web 应用中，新增 **「数字期权定价」** 模块。用户通过表单输入合约与市场参数，系统调用数字期权解析定价与 Greeks，在页面上展示**期权价格、Premium** 及**可用的 Greeks**（Delta 必现，Gamma/Vega/Theta 按类型与支付货币提供）。输入/输出口径与现有 Vanilla 模块、功能规格及 `models/digital` 实现保持一致，便于复用日期与折现约定（T1/T2）。

---

## 二、与现有模块的关系

| 项 | 说明 |
|----|------|
| **入口** | 在应用顶部导航中增加 **「数字期权定价」** 选项（与「Vanilla 定价」「组合期权定价」并列）；用户选择后展示数字期权专用表单与结果区。 |
| **共享输入** | 货币对、当前日期、起息日、到期日、交割日、即期、执行价、本币利率、外币利率、名义本金、买卖方向、期权类型（看涨/看跌）、隐含波动率；T1/T2 计算方式与 Vanilla 一致。 |
| **计算复用** | 直接调用现有 `models/digital` 的 `priceAndGreeks`（或等价接口），传入 `DigitalParams`；不新增定价公式，仅新增前端页面与参数组装。 |
| **类型与接口** | `DigitalParams` 继承 `GKParams`（S, K, T, T2, r_d, r_f, sigma），并增加 D、payoffCurrency、digitalKind；`DigitalResult` 含 price、delta，以及可选的 gamma、vega、theta。 |

---

## 三、数字期权类型与定价约定

### 3.1 数字种类（digitalKind）

| 种类 | 英文/内部名称 | 收益简述 | 支付金额 D |
|------|----------------|----------|------------|
| **现金或无** | `cashOrNothing` | 到期若触发则支付固定金额 D，否则 0 | 用户输入 D（> 0）；单位由「支付货币」决定 |
| **资产或无** | `assetOrNothing` | 到期若触发则支付 1 单位外币（本币计价），否则 0 | 等价 D=1 外币；界面可不展示 D 输入，或展示为「1 单位外币」只读 |

### 3.2 支付货币（payoffCurrency，仅 Cash-or-Nothing 有效）

| 支付货币 | 英文/内部名称 | 含义 |
|----------|----------------|------|
| 本币 | `domestic` | 触发时支付 D 单位本币；折现用 r_d、T2 |
| 外币 | `foreign` | 触发时支付 D 单位外币（本币计价 ≈ D·S_T）；公式用 d1、外币折现 |

### 3.3 定价公式（与功能规格、models/digital 一致）

- **Cash-or-Nothing 本币**：看涨 D·e^{-r_d·T2}·N(d2)，看跌 D·e^{-r_d·T2}·N(-d2)。  
- **Cash-or-Nothing 外币**：看涨 D·S·e^{-r_f·T}·N(d1)，看跌 D·S·e^{-r_f·T}·N(-d1)（本币计价）。  
- **Asset-or-Nothing**：看涨 S·e^{-r_f·T}·N(d1)，看跌 S·e^{-r_f·T}·N(-d1)（支付 1 单位外币，本币计价）。  
- d1、d2 与 Vanilla Garman-Kohlhagen 一致；T2 用于本币折现（交割日−起息日），T 用于 d1/d2 与外币折现。

---

## 四、输入规格

### 4.1 共享输入（与 Vanilla 一致）

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 1 | 货币对 | `currencyPair` | 字符串或下拉 | 如 EURUSD、USDCNY | 用于本币/外币展示与惯例 |
| 2 | 当前日期 | `today` | 日期 | YYYY-MM-DD | 定价基准日；≤ 起息日、≤ 到期日 |
| 3 | 起息日 | `premiumDate` | 日期 | YYYY-MM-DD | ≥ 当前日期 |
| 4 | 到期日 | `maturityDate` | 日期 | YYYY-MM-DD | ≥ 起息日 |
| 5 | 交割日 | `settlementDate` | 日期 | YYYY-MM-DD | ≥ 到期日（或按 T+2 惯例） |
| 6 | 即期价格 | `spot` / `S` | 数值 | 与货币对报价一致 | > 0 |
| 7 | 执行价格 | `strike` / `K` | 数值 | 与即期同报价 | > 0 |
| 8 | 本币利率 | `r_d` | 数值 | 小数（如 0.04） | 连续复利年化 |
| 9 | 外币利率 | `r_f` | 数值 | 小数（如 0.02） | 连续复利年化 |
| 10 | 名义本金 | `notional` | 数值 | 单位：外币 | > 0 |
| 11 | 买卖方向 | `longOrShort` | 枚举 | `long` / `short` | 多头/空头 |
| 12 | 期权类型 | `optionType` | 枚举 | `call` / `put` | 看涨/看跌 |
| 13 | 隐含波动率 | `sigma` | 数值 | 小数（如 0.06） | 年化；> 0 |

### 4.2 数字期权专用输入

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 14 | 数字种类 | `digitalKind` | 枚举 | `cashOrNothing` / `assetOrNothing` | 现金或无 / 资产或无 |
| 15 | 支付金额 | `D` | 数值 | 与支付货币一致（本币或外币单位） | 仅 **Cash-or-Nothing** 时必填；> 0。Asset-or-Nothing 时由系统视为 1 单位外币，可不展示或只读 |
| 16 | 支付货币 | `payoffCurrency` | 枚举 | `domestic` / `foreign` | 仅 **Cash-or-Nothing** 时有效；Asset-or-Nothing 固定为外币，前端可灰显或隐藏 |

**T1 / T2**：T1 = (到期日 − 当前日期) / 365，T2 = (交割日 − 起息日) / 365；与 Vanilla 一致，由前端从日期计算后传入 `DigitalParams`。

---

## 五、输出规格

| 序号 | 输出项（中文） | 英文/内部名称 | 含义 | 单位/展示方式 | 可用性 |
|------|----------------|---------------|------|----------------|--------|
| 1 | 期权价格 | `price` | 每单位名义本币的数字期权价值 | 小数 | 必现 |
| 2 | Premium | `premium` | 期权费金额 = 期权价格 × 名义本金 | 本币金额；可选外币等值、% of spot | 必现 |
| 3 | Delta | `delta` | ∂V/∂S | 每单位名义；头寸 Delta = delta × 名义本金 × 买卖方向，单位：外币 | 必现（计算层已支持全部类型） |
| 4 | Gamma | `gamma` | ∂²V/∂S² | 每单位名义 | Cash 本币、Asset 有；Cash 外币当前实现未提供时可标「—」或后续补充 |
| 5 | Vega | `vega` | ∂V/∂σ，按 1% 波动率 | 每单位名义；头寸 Vega = vega × 名义本金 × 买卖方向 | 有则展示（Cash 本币/外币、Asset 均有） |
| 6 | Theta | `theta` | ∂V/∂t，按 1 天 | 本币/天；头寸同理 | 仅 Cash 本币有解析实现时展示；其余可标「—」或后续补充 |

**说明**：Phi/Rho 在现有 `models/digital` 中未实现，首期可不展示；若后续在计算层补充，再在界面增加即可。输出单位与 Vanilla 模块保持一致（本币/外币、每单位名义/头寸）。

---

## 六、计算层与接口要求

1. **复用现有实现**：调用 `models/digital` 的 `priceAndGreeks(params: DigitalParams, optionType: OptionType)`，返回 `DigitalResult`（price, delta?, gamma?, vega?, theta?）。  
2. **参数组装**：前端将表单转为 `DigitalParams`：  
   - 从共享输入得到 S, K, T（=T1）, T2, r_d, r_f, sigma；  
   - 从数字专用输入得到 D, payoffCurrency, digitalKind；  
   - Asset-or-Nothing 时 D 可传 1、payoffCurrency 可不传或传 `foreign`，以现有实现为准。  
3. **买卖方向**：计算层输出为「多头」Greeks；前端根据 `longOrShort` 对 Delta/Vega/Theta 等取反（与 Vanilla 一致）。  
4. **名义本金与 Premium**：计算层返回每单位名义价格与 Greeks；前端 Premium = price × notional，头寸 Greeks = 对应 Greek × notional × 方向系数。

---

## 七、前端交互与 UI 要求

1. **布局**：输入区（表单）+ 结果区（输出表格或卡片）；与 Vanilla、组合期权模块风格统一。  
2. **数字专用控件**：  
   - 数字种类：下拉或单选「现金或无」「资产或无」；  
   - 选择「资产或无」时，支付金额可隐藏或只读「1 单位外币」，支付货币可灰显；  
   - 选择「现金或无」时，展示支付金额 D 与支付货币（本币/外币）。  
3. **计算触发**：点击「计算」按钮触发；可选修改输入后自动重新计算（防抖 300–500ms）。  
4. **校验**：  
   - 日期顺序与 Vanilla 一致（当前 ≤ 起息 ≤ 到期、交割 ≥ 到期等）；  
   - 即期、执行价、利率、波动率、名义本金 > 0；  
   - Cash-or-Nothing 时 D > 0。  
5. **输出展示**：期权价格、Premium（本币及可选外币/%）、Delta（及头寸 Delta）；若 `DigitalResult` 含 gamma、vega、theta 则展示，否则对应项标「—」或省略。  
6. **加载与异常**：计算中显示 loading；参数非法或计算失败时明确提示。

---

## 八、验收标准

| 项 | 验收内容 |
|----|----------|
| 1 | 在「外汇期权计算器」导航中可选择「数字期权定价」，并展示数字期权专用表单与结果区。 |
| 2 | 共享输入（货币对、日期、即期、执行价、利率、名义本金、买卖方向、期权类型、波动率）完整且校验与 Vanilla 一致。 |
| 3 | 数字种类可切换「现金或无」「资产或无」；Cash-or-Nothing 时可输入支付金额 D 与支付货币；Asset-or-Nothing 时行为与计算层一致（无 D 或 D=1 外币）。 |
| 4 | 输出：期权价格、Premium、Delta 必现；有 gamma/vega/theta 时展示，单位与说明正确；头寸 Greeks 与买卖方向正确。 |
| 5 | 与现有 `models/digital` 结果一致：用同一组 `DigitalParams` 在控制台或单元测试中调用 `priceAndGreeks`，与页面结果一致。 |

---

## 九、开发任务拆解（供开发团队执行）

| 步骤 | 任务 | 产出 |
|------|------|------|
| 1 | **导航与路由** | 在 App 中增加「数字期权定价」入口（与 Vanilla、组合期权并列）；点击后渲染数字期权页面。 |
| 2 | **数字期权页面** | 新建 `DigitalPricing` 组件（或等价页面组件）：共享表单区（日期、即期、执行价、利率、名义本金、买卖方向、期权类型、波动率）+ 数字专用表单项（数字种类、支付金额、支付货币）。 |
| 3 | **参数与调用** | 从表单组装 `DigitalParams`（含 T1、T2），调用 `priceAndGreeks`；根据 `longOrShort` 处理头寸 Greeks 符号；计算 Premium 与头寸 Delta/Vega 等。 |
| 4 | **结果展示与校验** | 展示期权价格、Premium、Delta（及头寸）、Gamma/Vega/Theta（有则展示）；实现与 Vanilla 一致的日期与数值校验。 |
| 5 | **联调与回归** | 用若干组参数（Cash 本币/外币、Asset、看涨/看跌、Long/Short）与 `models/digital` 单元测试或手算结果对比，确认一致。 |

---

## 十、参考：DigitalParams 与 DigitalResult（types.ts）

- **DigitalParams**：继承 GKParams（S, K, T, T2?, r_d, r_f, sigma）；扩展：`D: number`，`payoffCurrency?: 'domestic' | 'foreign'`，`digitalKind?: 'cashOrNothing' | 'assetOrNothing'`（默认 cashOrNothing）。  
- **DigitalResult**：`price: number`；`delta?: number`；`gamma?: number`；`vega?: number`；`theta?: number`。  

实现细节以 `models/digital/cashOrNothing.ts` 及 `models/types.ts` 为准。

---

**文档结束**。开发团队可按「九、开发任务拆解」执行；若业务需增加 Rho/Phi 或外币 Cash 的 Gamma/Theta，可在计算层补充后再在需求书中增加对应输出项。
