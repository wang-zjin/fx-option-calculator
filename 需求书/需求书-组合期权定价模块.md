# 需求书：组合期权定价模块

**文档版本**：v1.0  
**对应项目**：外汇期权计算器 — 阶段一 Web UI（在 Vanilla 定价计算器中新增模块）  
**关联文档**：[开发流程设计.md](../开发流程设计.md)、[需求书-Vanilla-Web定价界面.md](./需求书-Vanilla-Web定价界面.md)、[功能规格-期权类型与定价.md](../功能规格-期权类型与定价.md)  
**知识库参考**：组合定价场景与业务约定可查阅 `知识库/业务与需求/`、`知识库/定价与计算/`；索引见 [知识库/README.md](../知识库/README.md)。

---

## 一、需求概述

在现有 **外汇期权计算器 — Vanilla 定价** Web 应用中，新增 **「组合期权定价」** 模块。首期支持两类组合：

1. **RR（Risk Reversal，风险逆转）**
2. **海鸥期权（Seagull）**

其他组合（如 Strangle、Butterfly、Calendar 等）后续按业务需要再添加。组合定价基于 **Vanilla 欧式腿** 的线性叠加：每腿使用 Garman-Kohlhagen 定价与 Greeks，组合价格与 Greeks 为各腿按符号与名义加总。输入/输出口径与现有 Vanilla 模块一致（货币对、日期、T1/T2、本币/外币利率、名义本金等），便于开发复用与用户一致体验。

---

## 二、与现有 Vanilla 模块的关系

| 项 | 说明 |
|----|------|
| **入口** | 在现有「外汇期权计算器」页面中增加 **模块切换**：如 Tab 或导航为「Vanilla 定价」与「组合期权定价」；用户选择「组合期权定价」后进入本模块。 |
| **共享输入** | 货币对、当前日期、起息日、到期日、交割日、即期、本币/外币利率、名义本金等与 Vanilla 共用同一套约定（见 [需求书-Vanilla-Web定价界面.md](./需求书-Vanilla-Web定价界面.md)）；T1、T2 计算方式一致。 |
| **计算复用** | 组合内每一腿均为欧式 Vanilla，直接调用现有 `models/vanilla` 的 Garman-Kohlhagen 定价与 Greeks；不新增定价模型，仅新增「组合类型 + 腿定义 + 加总逻辑」。 |
| **扩展** | 新增组合类型时，仅增加「组合定义」（腿的组成、执行价、波动率、方向）与前端展示，计算层继续复用 Vanilla。 |

---

## 三、组合类型规格

### 3.1 RR（Risk Reversal，风险逆转）

**定义**（市场惯例之一，可与知识库/业务约定核对后微调）：

- **Long RR**：买入 1 份 OTM 看涨 + 卖出 1 份 OTM 看跌（通常 Delta 对称，如 25Δ Call 与 25Δ Put）。
- **Short RR**：卖出 1 份 OTM 看涨 + 买入 1 份 OTM 看跌。
- 定价：**组合价格 = 腿1 价格 + 腿2 价格**（考虑符号：Long 腿为正、Short 腿为负）。  
  例：Long RR = Price(Call K_call) − Price(Put K_put)。

**腿结构**（首期按执行价输入，Delta 对称为可选扩展）：

| 腿 | 方向 | 类型 | 执行价 | 波动率 | 说明 |
|----|------|------|--------|--------|------|
| 腿1 | 由「RR 方向」决定 | Call | K_call | σ_call | K_call > 即期（OTM Call） |
| 腿2 | 与腿1 相反 | Put | K_put | σ_put | K_put < 即期（OTM Put） |

**输入项（在共享输入基础上增加）**：

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 1 | RR 方向 | `rrDirection` | 枚举 | `long` / `short` | Long RR = 买 Call + 卖 Put；Short RR = 卖 Call + 买 Put |
| 2 | Call 执行价 | `strikeCall` / `K_call` | 数值 | 与即期同报价 | > 即期（OTM Call）；> 0 |
| 3 | Put 执行价 | `strikePut` / `K_put` | 数值 | 与即期同报价 | < 即期（OTM Put）；> 0 |
| 4 | Call 腿波动率 | `sigmaCall` | 数值 | 小数（如 0.06） | 年化隐含波动率；> 0 |
| 5 | Put 腿波动率 | `sigmaPut` | 数值 | 小数（如 0.06） | 年化隐含波动率；> 0 |

**输出**：组合期权价格（每单位名义）、Premium（组合价格 × 名义本金）、组合 Delta/Gamma/Vega/Theta/Phi/Rho（各腿 Greeks 按腿方向加总，单位与 Vanilla 一致）。

---

### 3.2 海鸥期权（Seagull）

**定义**（常见一种，可与知识库/业务约定核对后微调）：

- **经典海鸥**：Long 1 份 OTM 看涨 (K_high) + Short 1 份 看跌 (K_mid) + Short 1 份 OTM 看跌 (K_low)。  
  执行价关系：**K_low < K_mid < 即期 < K_high**（K_mid 可为 ATM 或介于 K_low 与即期之间）。
- 定价：**组合价格 = Price(Call K_high) − Price(Put K_mid) − Price(Put K_low)**（每腿 1 单位名义）。

**腿结构**：

| 腿 | 方向 | 类型 | 执行价 | 波动率 | 说明 |
|----|------|------|--------|--------|------|
| 腿1 | Long | Call | K_high | σ_call | K_high > 即期 |
| 腿2 | Short | Put | K_mid | σ_put_mid | K_mid < 即期（常取 ATM 附近） |
| 腿3 | Short | Put | K_low | σ_put_low | K_low < K_mid |

**输入项（在共享输入基础上增加）**：

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 1 | Call 执行价（高） | `strikeCall` / `K_high` | 数值 | 与即期同报价 | > 即期；> 0 |
| 2 | Put 执行价（中） | `strikePutMid` / `K_mid` | 数值 | 与即期同报价 | < 即期；建议 K_low < K_mid；> 0 |
| 3 | Put 执行价（低） | `strikePutLow` / `K_low` | 数值 | 与即期同报价 | < K_mid；> 0 |
| 4 | Call 腿波动率 | `sigmaCall` | 数值 | 小数 | 年化；> 0 |
| 5 | Put 腿波动率（中） | `sigmaPutMid` | 数值 | 小数 | 年化；> 0 |
| 6 | Put 腿波动率（低） | `sigmaPutLow` | 数值 | 小数 | 年化；> 0 |

**说明**：若业务约定「三腿共用单一波动率」，可首期在 UI 上提供「统一波动率」选项，三腿使用同一 σ。

**输出**：组合期权价格（每单位名义）、Premium、组合 Delta/Gamma/Vega/Theta/Phi/Rho（各腿加总）。

---

## 四、共享输入与输出口径

**共享输入**（与 Vanilla 一致，用于 T1/T2 与折现、名义本金）：

- 货币对、当前日期、起息日、到期日、交割日  
- 即期价格、本币利率、外币利率、名义本金  

**T1 / T2**：T1 = (到期日 − 当前日期) / 365，T2 = (交割日 − 起息日) / 365；各腿共用同一 T1、T2。

**输出口径**（与 Vanilla 对齐）：

| 输出项 | 含义 | 单位/展示 |
|--------|------|-----------|
| 组合期权价格 | 每单位名义本币价值（各腿价格代数和） | 小数 |
| Premium | 组合价格 × 名义本金 | 本币金额；可选外币等值、% of spot |
| Delta | 各腿 Delta 代数和 | 头寸单位：外币（如 EUR） |
| Gamma | 各腿 Gamma 代数和 | 每单位名义 |
| Vega | 各腿 Vega 代数和（按 1% 波动率） | 每单位名义；头寸 Vega = × 名义本金 |
| Theta / Time Decay | 各腿 Theta 代数和（按 1 天） | 本币/天；头寸同理 |
| Phi (Rho_f) | 各腿 Phi 代数和 | 按 1bp 或 1 单位利率 |
| Rho (Rho_d) | 各腿 Rho 代数和 | 按 1bp 或 1 单位利率 |

**可选**：在结果区展示「分腿明细」（每腿价格、Delta、Vega 等），便于核对与教学。

---

## 五、前端与交互要求

1. **模块入口**：在现有应用顶部或左侧增加「Vanilla 定价」与「组合期权定价」切换（Tab 或导航链接）；当前为「组合期权定价」时，展示组合类型选择与对应表单。
2. **组合类型选择**：下拉或单选「RR」「海鸥」；切换类型时，表单仅展示该类型所需额外输入（RR：K_call, K_put, σ_call, σ_put；海鸥：K_high, K_mid, K_low, σ_call, σ_put_mid, σ_put_low 或统一 σ）。
3. **共享表单区**：货币对、日期、即期、利率、名义本金等与 Vanilla 共用同一套控件与校验规则（日期顺序、数值 > 0 等）。
4. **计算与展示**：点击「计算」后，调用组合定价逻辑，展示组合价格、Premium、组合 Greeks；可选展示分腿明细表。
5. **错误与加载**：参数非法或计算异常时，与 Vanilla 模块一致地提示；计算中可显示 loading。

---

## 六、计算层要求

1. **复用 Vanilla**：每一腿调用现有 `priceAndGreeks(params, optionType, longOrShort)`（或等价接口），params 含 S, K, T1, T2, r_d, r_f, sigma；K 与 sigma 为该腿执行价与波动率，longOrShort 为该腿在组合中的方向（Long 为正、Short 为负）。
2. **组合层**：
   - **RR**：腿1 = Call(K_call, σ_call)，腿2 = Put(K_put, σ_put)；Long RR 时腿1 系数 +1、腿2 系数 −1；Short RR 时相反。组合价格 = 腿1 价格 − 腿2 价格（Long RR）；组合 Greeks = 腿1 Greeks − 腿2 Greeks。
   - **海鸥**：腿1 = +1 × Call(K_high, σ_call)，腿2 = −1 × Put(K_mid, σ_put_mid)，腿3 = −1 × Put(K_low, σ_put_low)。组合价格与 Greeks = 三腿代数和。
3. **名义本金与头寸**：计算层可只算「每单位名义」；前端用「组合价格 × 名义本金」得到 Premium，用「组合 Delta × 名义本金」等得到头寸 Greeks（无需再按「组合方向」取反，因腿方向已在系数中体现）。
4. **扩展**：新增组合类型时，在计算层增加「组合类型枚举 + 腿列表（执行价、类型、方向、波动率）」，循环调用 Vanilla 并加总即可。

---

## 七、验收标准

| 项 | 验收内容 |
|----|----------|
| 1 | 在现有 Vanilla 计算器页面中可切换到「组合期权定价」模块，并可在「RR」「海鸥」之间选择组合类型。 |
| 2 | RR：输入共享参数 + K_call, K_put, σ_call, σ_put 及 RR 方向后，得到组合价格、Premium、组合 Delta/Gamma/Vega/Theta/Phi/Rho；与「手算」各腿 Vanilla 后加总结果一致。 |
| 3 | 海鸥：输入共享参数 + K_high, K_mid, K_low 及三腿波动率（或统一 σ）后，得到组合价格、Premium、组合 Greeks；与三腿 Vanilla 代数和一致。 |
| 4 | 共享输入（日期、即期、利率、名义本金）与 Vanilla 模块约定一致；T1/T2 计算方式一致。 |
| 5 | 可选：分腿明细（每腿价格、Delta、Vega 等）展示正确。 |

---

## 八、开发任务拆解（供开发团队执行）

| 步骤 | 任务 | 产出 |
|------|------|------|
| 1 | **路由/模块切换** | 在 App 中增加「Vanilla / 组合期权」切换；组合期权页或 Tab 内包含「组合类型」选择（RR、海鸥）。 |
| 2 | **组合计算层** | 新增 `models/combination/`（或等价目录）：RR 与海鸥的腿定义、调用 Vanilla、按符号加总价格与 Greeks；导出统一接口如 `priceCombination(type, sharedParams, legParams)`。 |
| 3 | **组合 RR 表单与结果** | 共享表单 + RR 专用输入（K_call, K_put, σ_call, σ_put, 方向）；结果区展示组合价格、Premium、组合 Greeks。 |
| 4 | **组合海鸥表单与结果** | 共享表单 + 海鸥专用输入（K_high, K_mid, K_low，三腿 σ 或统一 σ）；结果区展示组合价格、Premium、组合 Greeks。 |
| 5 | **校验与一致性** | 用已知 Vanilla 案例手算 RR/海鸥各腿并加总，与模块输出对比；必要时在 Issues 记录用例与结果。 |

---

## 九、后续扩展（其他组合）

以下可在首期 RR、海鸥上线后再按业务需要添加；实现方式均为「定义腿列表 + 调用 Vanilla + 加总」：

| 组合类型 | 简要结构 | 备注 |
|----------|----------|------|
| Strangle | Long OTM Call + Long OTM Put | 执行价 K_call > spot > K_put |
| Butterfly | Long 1 Call(K_low) + Short 2 Call(K_mid) + Long 1 Call(K_high) 等 | 可先做 Call Butterfly |
| Calendar / 其他 | 多期限或多腿 | 需扩展 T1  per 腿或期限结构 |

新增组合时，在需求书或知识库中补充该组合的**腿结构表**与**输入项表**，开发按同一模式加腿与加总即可。

---

**文档结束**。开发团队可按「八、开发任务拆解」执行；组合定价场景若在知识库中有更细业务约定（如 RR 25Δ 惯例、海鸥 K_mid 取法），以知识库为准，本需求书可再补一版「业务约定附录」。
