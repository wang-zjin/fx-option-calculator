# 需求书：美式期权模块

**文档版本**：v1.0  
**对应项目**：外汇期权计算器 — 阶段一 Web UI（在现有计算器中新增模块）  
**关联文档**：[开发流程设计.md](../开发流程设计.md)、[需求书-Vanilla-Web定价界面.md](./需求书-Vanilla-Web定价界面.md)、[功能规格-期权类型与定价.md](../功能规格-期权类型与定价.md)  
**计算层依据**：现有 `models/american/`（CRR 二叉树 / 三叉树），类型见 `models/types.ts` 中 `AmericanParams`、`AmericanResult`、`EarlyExerciseBoundaryPoint`。

---

## 一、需求概述

在现有 **外汇期权计算器** Web 应用中，新增 **「美式期权定价」** 模块。用户通过表单输入合约与市场参数，系统调用美式期权树模型（二叉树或三叉树）定价及数值 Greeks，在页面上展示**美式期权价格、Premium、提前行权价值（与欧式价差）**及**Delta/Gamma/Vega/Theta**；美式看跌可选展示**早期行权边界**。输入/输出口径与现有 Vanilla 模块、功能规格及 `models/american` 实现保持一致。

---

## 二、与现有模块的关系

| 项 | 说明 |
|----|------|
| **入口** | 在应用顶部导航中增加 **「美式期权定价」** 选项（与 Vanilla、组合期权、数字期权并列）；用户选择后展示美式期权专用表单与结果区。 |
| **共享输入** | 货币对、当前日期、起息日、到期日、交割日、即期、执行价、本币利率、外币利率、名义本金、买卖方向、期权类型（看涨/看跌）、隐含波动率；T1 = (到期日−当前日期)/365 用于树期限。 |
| **计算复用** | 直接调用现有 `models/american` 的 `priceAmerican(params, optionType)`，传入 `AmericanParams`；不新增定价算法，仅新增前端页面与参数组装。 |
| **类型与接口** | `AmericanParams` 继承 `GKParams`（S, K, T, T2?, r_d, r_f, sigma），并增加 steps、treeType；`AmericanResult` 含 price、earlyExercisePremium、delta、gamma、vega、theta、earlyExerciseBoundary（看跌可选）。 |

---

## 三、美式期权定义与定价约定

### 3.1 定义与收益（与功能规格一致）

- 收益与 Vanilla 相同：看涨 max(S_T − K, 0)，看跌 max(K − S_T, 0)。
- **可在到期前任意时刻行权**（美式行权）。
- 无股息/无离散利息时：**美式看涨**最优不提前行权，价格 = 欧式看涨；**美式看跌**可能提前行权，价格 ≥ 欧式看跌。

### 3.2 定价模型（与 models/american 一致）

- **二叉树**：Cox-Ross-Rubinstein (CRR)，步数 n，每步 Δt = T/n，漂移 r_d − r_f，贴现 r_d。
- **三叉树**：每步三种状态（上/平/下），概率由一、二阶矩匹配；贴现与美式行权判断同二叉树。
- 树期限使用 **T = T1**（到期日 − 当前日期，年化）；T2 当前实现未参与树构造，仅与 GKParams 兼容；Premium = 期权价格 × 名义本金（估值日口径，若需折现到起息日可后续扩展）。

### 3.3 树类型与步数

| 参数 | 英文/内部名称 | 可选值 | 说明 |
|------|----------------|--------|------|
| 树类型 | `treeType` | `crr` / `trinomial` | CRR 二叉树（默认）/ 三叉树 |
| 树步数 | `steps` | 正整数（如 100、200） | 默认 200；步数越大精度越高、计算越慢 |

---

## 四、输入规格

### 4.1 共享输入（与 Vanilla 一致）

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 1 | 货币对 | `currencyPair` | 字符串或下拉 | 如 EURUSD、USDCNY | 用于本币/外币展示与惯例 |
| 2 | 当前日期 | `today` | 日期 | YYYY-MM-DD | 定价基准日；≤ 起息日、≤ 到期日 |
| 3 | 起息日 | `premiumDate` | 日期 | YYYY-MM-DD | ≥ 当前日期 |
| 4 | 到期日 | `maturityDate` | 日期 | YYYY-MM-DD | ≥ 起息日 |
| 5 | 交割日 | `settlementDate` | 日期 | YYYY-MM-DD | ≥ 到期日 |
| 6 | 即期价格 | `spot` / `S` | 数值 | 与货币对报价一致 | > 0 |
| 7 | 执行价格 | `strike` / `K` | 数值 | 与即期同报价 | > 0 |
| 8 | 本币利率 | `r_d` | 数值 | 小数（如 0.04） | 连续复利年化 |
| 9 | 外币利率 | `r_f` | 数值 | 小数（如 0.02） | 连续复利年化 |
| 10 | 名义本金 | `notional` | 数值 | 单位：外币 | > 0 |
| 11 | 买卖方向 | `longOrShort` | 枚举 | `long` / `short` | 多头/空头 |
| 12 | 期权类型 | `optionType` | 枚举 | `call` / `put` | 看涨/看跌 |
| 13 | 隐含波动率 | `sigma` | 数值 | 小数（如 0.06） | 年化；> 0 |

### 4.2 美式期权专用输入

| 序号 | 输入项（中文） | 英文/内部名称 | 数据类型 | 单位/格式 | 校验与说明 |
|------|----------------|---------------|----------|-----------|------------|
| 14 | 树类型 | `treeType` | 枚举 | `crr` / `trinomial` | CRR 二叉树 / 三叉树；默认 `crr` |
| 15 | 树步数 | `steps` | 正整数 | 如 100、200 | 默认 200；建议范围 50–500，步数过大影响性能 |

**T1**：T1 = (到期日 − 当前日期) / 365，由前端从日期计算后传入 `AmericanParams.T`；树模型使用该 T。

---

## 五、输出规格

| 序号 | 输出项（中文） | 英文/内部名称 | 含义 | 单位/展示方式 | 说明 |
|------|----------------|---------------|------|----------------|------|
| 1 | 美式期权价格 | `price` | 每单位名义本币的美式期权价值 | 小数 | 必现；树模型输出 |
| 2 | Premium | `premium` | 期权费金额 = 美式期权价格 × 名义本金 | 本币金额；可选外币等值、% of spot | 必现 |
| 3 | 提前行权价值 | `earlyExercisePremium` | 美式价格 − 欧式价格（同参数下） | 小数（每单位名义）；可选展示金额（× 名义本金） | 必现；便于理解美式溢价 |
| 4 | Delta | `delta` | ∂V/∂S，数值差分 | 每单位名义；头寸 Delta = delta × 名义本金 × 买卖方向，单位：外币 | 必现 |
| 5 | Gamma | `gamma` | ∂²V/∂S²，数值差分 | 每单位名义 | 必现 |
| 6 | Vega | `vega` | ∂V/∂σ，按 1% 波动率，数值差分 | 每单位名义；头寸 Vega = vega × 名义本金 × 买卖方向 | 必现 |
| 7 | Theta | `theta` | ∂V/∂t，按 1 天，数值差分 | 本币/天；头寸同理 | 必现 |
| 8 | 早期行权边界 | `earlyExerciseBoundary` | 美式看跌：各时刻临界即期 S*，低于此应提前行权 | 列表：[(t, S), …]；t 为距到期年数，S 为临界即期 | 仅**美式看跌**时由计算层返回；可选展示为表格或简要说明 |

**说明**：Greeks 为数值差分（bump S、σ、T），与 Vanilla 解析 Greeks 单位一致（Delta 头寸为外币，Vega 按 1%，Theta 按 1 天）。Phi/Rho 当前计算层未实现，首期可不展示；若后续补充再在界面增加。

---

## 六、计算层与接口要求

1. **复用现有实现**：调用 `models/american` 的 `priceAmerican(params: AmericanParams, optionType: OptionType)`，返回 `AmericanResult`（price, earlyExercisePremium, delta, gamma, vega, theta, earlyExerciseBoundary?）。  
2. **参数组装**：前端将表单转为 `AmericanParams`：  
   - 从共享输入得到 S, K, T（= T1）, r_d, r_f, sigma；  
   - 从美式专用输入得到 steps（默认 200）、treeType（默认 `crr`）；  
   - T2 可选传入（当前树实现未使用，与 GKParams 兼容即可）。  
3. **买卖方向**：计算层输出为「多头」Greeks；前端根据 `longOrShort` 对 Delta/Vega/Theta 等取反（与 Vanilla 一致）。  
4. **名义本金与 Premium**：Premium = price × notional；头寸 Greeks = 对应 Greek × notional × 方向系数。  
5. **欧式对比**：计算层已内部调用欧式价格并返回 earlyExercisePremium；前端可直接展示，无需再调 Vanilla。

---

## 七、前端交互与 UI 要求

1. **布局**：输入区（表单）+ 结果区（输出表格或卡片）；与 Vanilla、数字期权等模块风格统一。  
2. **美式专用控件**：树类型（下拉或单选：CRR 二叉树 / 三叉树）；树步数（数字输入，默认 200，占位提示如「50–500」）。  
3. **计算触发**：点击「计算」按钮触发；美式树计算可能略慢，计算中需明确 loading。  
4. **校验**：日期顺序与 Vanilla 一致；即期、执行价、利率、波动率、名义本金 > 0；树步数为正整数，建议 2–1000。  
5. **输出展示**：美式期权价格、Premium、提前行权价值、Delta（及头寸）、Gamma、Vega、Theta；美式看跌若有 earlyExerciseBoundary，可折叠或表格展示「早期行权边界」列表。  
6. **加载与异常**：计算中显示 loading；参数非法或计算失败时明确提示；步数过大导致超时可提示减小步数。

---

## 八、验收标准

| 项 | 验收内容 |
|----|----------|
| 1 | 在「外汇期权计算器」导航中可选择「美式期权定价」，并展示美式专用表单与结果区。 |
| 2 | 共享输入完整且校验与 Vanilla 一致；美式专用输入：树类型（crr/trinomial）、树步数（默认 200）可用。 |
| 3 | 输出：美式期权价格、Premium、提前行权价值、Delta、Gamma、Vega、Theta 必现；单位与买卖方向正确。 |
| 4 | 美式看跌时，若有早期行权边界则展示（表格或列表）；美式看涨时提前行权价值 ≈ 0（与欧式价格一致）。 |
| 5 | 与现有 `models/american` 结果一致：同一组 AmericanParams 在控制台或单元测试中调用 `priceAmerican`，与页面结果一致。 |

---

## 九、开发任务拆解（供开发团队执行）

| 步骤 | 任务 | 产出 |
|------|------|------|
| 1 | **导航与入口** | 在 App 中增加「美式期权定价」入口（与 Vanilla、组合、数字并列）；点击后渲染美式期权页面。 |
| 2 | **美式期权页面** | 新建 `AmericanPricing` 组件：共享表单区（日期、即期、执行价、利率、名义本金、买卖方向、期权类型、波动率）+ 美式专用表单项（树类型、树步数）。 |
| 3 | **参数与调用** | 从表单组装 `AmericanParams`（含 T1），调用 `priceAmerican`；根据 `longOrShort` 处理头寸 Greeks 符号；计算 Premium、展示 earlyExercisePremium。 |
| 4 | **结果展示与边界** | 展示价格、Premium、提前行权价值、Delta/Gamma/Vega/Theta（及头寸）；美式看跌且返回 earlyExerciseBoundary 时展示边界表。 |
| 5 | **校验与性能** | 日期与数值校验；步数过大时可选提示或限幅；用若干组参数与 `models/american` 单元测试或手算对比。 |

---

## 十、参考：AmericanParams 与 AmericanResult（types.ts）

- **AmericanParams**：继承 GKParams（S, K, T, T2?, r_d, r_f, sigma）；扩展：`steps?: number`（默认 200），`treeType?: 'crr' | 'trinomial'`（默认 `crr`）。  
- **AmericanResult**：`price: number`；`earlyExercisePremium?: number`；`delta?: number`；`gamma?: number`；`vega?: number`；`theta?: number`；`earlyExerciseBoundary?: EarlyExerciseBoundaryPoint[]`。  
- **EarlyExerciseBoundaryPoint**：`t: number`（距到期年数），`S: number`（临界即期）。  

实现细节以 `models/american/binomialTree.ts` 及 `models/types.ts` 为准。

---

**文档结束**。开发团队可按「九、开发任务拆解」执行；若业务需 Rho/Phi 或 Premium 折现到起息日，可在计算层/需求书中后续补充。
